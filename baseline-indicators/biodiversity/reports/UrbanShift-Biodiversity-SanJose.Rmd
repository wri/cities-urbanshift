---
title: "UrbanShift Biodiversity Indicators"
author: "Saif Shabou"
date: "`r format (Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    theme: spacelab
    highlight: tango
    number_sections: yes
    code_folding: hide
---

```{r Libraries, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}

# library(shiny)
library(plotly)
library(leaflet)
library(plyr)
library(dplyr)
library(ggplot2)
library(rgdal)
library(tidyverse)
library(sf)
library(rgeos)
library(httr)
library(jsonlite)
library(raster)
library(data.table)
library(leaflet.providers)
library(knitr)
library(kableExtra)

col_BoldRiverBlue = "#242456"
col_BoldSunYellow = "#FFD450"
col_BoldGrassGreen = "#2A553E"
col_BoldEarthGrey = "#7B7A66"
col_BoldBrickOrange = "#F26640"
col_LightRiverBlue = "#E3E6FF"
col_LightSunYellow = "#FFEDBA"
col_LightGrassGreen = "#C4F4D5"
col_LightEarthGrey = "#ECE2D6"
col_LightBrickOrange = "#FED3CF"
col_White = "#FFFFFF"
col_Black = "#000000"



```

# The UrbanShift project

## Objectives

UrbanShift is a global program that supports cities to adopt integrated approaches to urban development, shaping low-carbon, climate-resilient communities where people and planet both can thrive. The program is funded by the Global Environment Facility (GEF) and jointly managed by a global team consisting of the United Nations Environment Program (UNEP), World Resources Institute (WRI), C40 Cities and ICLEI Local Governments for Sustainability. The initiative supports 23 cities across nine countries, providing the knowledge, tools and training they need to transform their urban fabric and shift towards a more sustainable, equitable future.

As one of the key activities to support development of a knowledge-base for the UrbanShift initiative and all participant cities, the WRI data team will work with UrbanShift cities to identify and provide all cities with a common set of critical spatial data layers. using open source, global data. World Resources Institute is providing several types of data-related assistance to participating cities:

- A suite of key geo-spatial layers
- Baseline measurements of core UrbanShift indicators
- Geo-spatial analysis on selected thematic areas
- Capacity building and technical assistance on data governance and geospatial data as part of the City Academy and Labs modules of UrbanShift.

Outputs will include datasets, indicators and replicable analysis methods relevant to all cities. Additionally, analyses customized to the specific themes of interest for each city will be provided. Finally, an UrbanShift Lab will be delivered for which these data and analyses may act as one input.

## Baseline indicators

To help understand the current status and identify changes of sustainability in UrbanShift cities, we aim to measure **key baseline indicators** for all cities using comparable approaches. The selected indicators focus on measuring the status and change on the core objectives of the global project, which are aligned with three of Global Environment Facility's [focal areas for its current investment cycle (GEF-7)](https://www.thegef.org/documents/gef-7-programming-directions):**land degradation, biodiversity, and greenhouse gas emissions**. 

These assessments are intended to provide information to evaluate patterns within and between cities and to provide contextual information to cities to help them with problem and solution definition. We will disseminate the results to help local governments, the global project team, implementing agencies and national governments to gain a better understanding of the citiesâ€™ current status as it relates to sustainability efforts, capacities, main needs and opportunities, and planned investments.

# Biodiversity

## Context

## Data sources


- **Global Biodiversity Information Facility (GBIF)**: [The Global Biodiversity Information Facility (GBIF)](https://www.gbif.org/en/) is an international network and data infrastructure funded by the world's governments and aimed at providing anyone, anywhere, open access to data about all types of life on Earth. 

- **The World Database on Protected Areas (WDPA)**: [The World Database on Protected Areas (WDPA)](https://www.protectedplanet.net/en) is the most comprehensive global database of marine and terrestrial protected areas. It is a joint project between UN Environment Programme and the International Union for Conservation of Nature (IUCN), and is managed by UN Environment Programme World Conservation Monitoring Centre (UNEP-WCMC), in collaboration with governments, non-governmental organisations, academia and industry.

- **The Global Invasive Species Database (GISD)**: [The Global Invasive Species Database (GISD)](http://www.iucngisd.org/gisd/) is a free, online searchable source of information about alien and invasive species that negatively impact biodiversity. It focuses on invasive alien species that threaten native biodiversity and natural areas and covers all taxonomic groups from micro-organisms to animals and plants.

## Biodiversity indicators

| Indicator name | Description |Used datasets | Years |
| ------- | ------- | ------- | ------- | 
| Number of reported birds | Number of reported birds within the administrative boundaries of the selected city (both metropolitan and municipality levels) | `GBIF`, `geBoundaries` | 2020 |
| Number of reported birds by order | Number of reported birds broken down by orders within the administrative boundaries of the selected city (both metropolitan and municipality levels) | `GBIF`, `geBoundaries` | 2020 |
| Number of reported birds by family | Number of reported birds broken down by family within the administrative boundaries of the selected city (both metropolitan and municipality levels) | `GBIF`, `geBoundaries` | 2020 |
| Number of reported birds by genus | Number of reported birds broken down by genus within the administrative boundaries of the selected city (both metropolitan and municipality levels) | `GBIF`, `geBoundaries` | 2020 |
| Percent of protected area | For each municipality, percent of land protected as a protected area as defined by IUCN or CBD. | `WDPA`, `geBoundaries` | 2020 |

# Case study: San Jose

## Birds

### Metropolitan level

- **Location of reported birds:**

```{r Birds_map, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# read Boundary
boundary = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/data/boundaries/CRI-San_Jose-boundary.geojson",
                    quiet = TRUE)

birds2020 = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/data/biodiversity/biodiversity_map_layers_birds2020_sanjose.geojson",
                    quiet = TRUE)


label_birds2020 <- sprintf(
  "<strong>%s</strong><br/><strong>%s</strong><br/>",
  paste("Family", birds2020$family, sep=": "), 
  paste("Genus", birds2020$genus, sep =": ")
) %>% 
  lapply(htmltools::HTML)

leaflet(data = boundary, height = 500, width = "100%") %>% 
  addTiles() %>%
  addProviderTiles("OpenStreetMap.France", group = "OSM") %>%
  addProviderTiles(providers$CartoDB.DarkMatter , group = "CartoDB") %>% 
  # addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # setView(lat = boundary_centroid_lat,
  #         lng = boundary_centroid_lon,
  #         zoom = 9) %>% 
  # Add boundaries
  addPolygons(data = boundary,
              group = "Administrative boundaries",
              stroke = TRUE, color = col_Black, weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = TRUE, fillOpacity = 0.2,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>%
  addMarkers(birds2020$lon, 
             birds2020$lat,
             popup = ~as.character(birds2020$family),
             label = label_birds2020,
             clusterOptions = markerClusterOptions(),
             group = "Birds clusters") %>% 
  # add birds layer
  addCircleMarkers(birds2020$lon, birds2020$lat, 
                   radius = 3,
                   fillColor = col_BoldBrickOrange,
                   color  = "black",
                   stroke = TRUE,
                   weight = 0.8,
                   fillOpacity = 0.6,
                   popup = ~as.character(birds2020$family),
                   label = label_birds2020,
                   group = "Birds observations") %>% 
  # Layers control
  addLayersControl(
    baseGroups = c("OSM","CartoDB"),
    overlayGroups = c("Birds clusters","Birds observations"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
    hideGroup("Birds observations")
```

- **Number of reported birds by order:**

```{r Birds_stat_sanjose_orders, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# orders ----
birds2020_stats_orders = birds2020 %>% 
  as.data.frame() %>% 
  group_by(order) %>%
  summarise(nb_species = n()) %>% 
  arrange(desc(nb_species)) %>% 
  dplyr::select(`order name` = order,
         `Number of species`= nb_species)

# plot chart
birds2020_stats_orders %>% 
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(`order name`), 
            y = ~`Number of species`, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Number of birds by order (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~`Number of species`),
         yaxis = list(title = 'Number of observations in 2020'))
```

- **Number of reported birds by family:**

```{r Birds_stat_sanjose_family, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# families ----

birds2020_stats_families = birds2020 %>% 
  as.data.frame() %>% 
  group_by(family) %>%
  summarise(nb_species = n()) %>% 
  arrange(desc(nb_species)) %>% 
  dplyr::select(`family name` = family,
                `Number of species`= nb_species)

# plot chart
birds2020_stats_families %>% 
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(`family name`), 
            y = ~`Number of species`, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Number of birds by family (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~`Number of species`),
         yaxis = list(title = 'Number of observations in 2020'))
         
```

- **Number of reported birds by genus:**

```{r Birds_stat_sanjose_genus, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# genus ----

birds2020_stats_genus = birds2020 %>% 
  as.data.frame() %>% 
  group_by(genus) %>%
  summarise(nb_species = n()) %>% 
  arrange(desc(nb_species)) %>% 
  dplyr::select(`genus name` = genus,
                `Number of species`= nb_species)

# plot table
birds2020_stats_genus %>% 
  arrange(desc(`Number of species`)) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, font_size = 13)%>% 
  scroll_box(width = "100%", height = "400px")
         
```

### Municipality level

```{r Birds_map_adm2, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
boundary_municipality = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/boundaries-CRI-San_Jose-ADM2.geojson",
                                quiet = TRUE)

# find birds observations within municipalities polygons
birds_in_geo_adm2 <- st_join(x = birds2020, 
                             y = boundary_municipality, 
                             join = st_within)

# agregate number of birds observations by municipality 
birds_in_geo_adm2_stat = birds_in_geo_adm2 %>% 
  as.data.frame() %>% 
  count(shapeName.1) %>% 
  dplyr::select(shapeName.1,
         nb_species = n)  
  
# join with geo
birds_adm2_stat_geo = boundary_municipality %>% 
  left_join(birds_in_geo_adm2_stat,
            by = c("shapeName.1"))

# prepare map

# define color palette for urban expansion levels
pal_nbspecieis_municipality <- colorNumeric(palette = "Reds", 
                                             domain = birds_adm2_stat_geo$nb_species,
                                             na.color = "transparent",
                                             revers = FALSE)

# define map labels
labels_adm2_nbspecies <- sprintf("<strong>%s</strong><br/>%s: %s %s",
                  birds_adm2_stat_geo$shapeName.1, 
                  "Observations: ",
                  round(birds_adm2_stat_geo$nb_species, 2), "") %>% 
  lapply(htmltools::HTML)


# plot map
leaflet(height = 500, width = "100%") %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.DarkMatter , group = "CartoDB") %>%
  addProviderTiles("OpenStreetMap.France", group = "OSM") %>%
  addPolygons(data = birds_adm2_stat_geo,
              group = "Nb species",
              fillColor = ~pal_nbspecieis_municipality(nb_species),
              weight = 1,
              opacity = 1,
              color = "grey",
              fillOpacity = 0.7,
              label = labels_adm2_nbspecies,
              highlightOptions = highlightOptions(color = "black", weight = 2,
                                                  bringToFront = FALSE),
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 6px"),
                textsize = "15px",
                direction = "auto")) %>% 
  addLegend(pal = pal_nbspecieis_municipality, 
            values = birds_adm2_stat_geo$nb_species, 
            opacity = 0.9, 
            title = "Number of species (2020)",
            position = "topright",
            labFormat = labelFormat(suffix = "")) %>%
  # add birds layer
  addCircleMarkers(birds2020$lon, birds2020$lat,
                   radius = 3,
                   fillColor = col_BoldRiverBlue,
                   color  = "black",
                   stroke = TRUE,
                   weight = 0.8,
                   fillOpacity = 0.6,
                   label = label_birds2020,
                   group = "Birds observations") %>% 
  # Layers control
  addLayersControl(
    baseGroups = c("CartoDB","OSM"),
    overlayGroups = c("Nb species", "Birds observations"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  hideGroup("Birds observations")
```

```{r Birds_barplot_adm2, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# plot chart
birds_in_geo_adm2_stat %>% 
  arrange(desc(nb_species)) %>%
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(shapeName.1), 
            y = ~nb_species, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Number of birds by municipality (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~nb_species),
         yaxis = list(title = 'Number of observations in 2020'))
```


## Prrtected areas

```{r protected_area_map, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# protected areas map -----
protected_areas_sanjose = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/biodiversity_map_layers_protected_areas_sanjose.geojson",
                                    quiet = TRUE)

leaflet(data = boundary, height = 500, width = "100%") %>% 
  addTiles() %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addProviderTiles("OpenStreetMap.France", group = "OSM") %>%
  addProviderTiles(providers$CartoDB.DarkMatter , group = "CartoDB") %>% 
  # Add boundaries: metropolitan
  addPolygons(data = boundary,
              group = "Administrative boundaries",
              stroke = TRUE, color = col_Black, weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = FALSE, fillOpacity = 0.2,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>%
  # Add boundaries: Municipality
  addPolygons(data = boundary_municipality,
              group = "Municipality boundaries",
              stroke = TRUE, color = "gray", weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = TRUE, fillOpacity = 0.2,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>%
  # add protected areas layer
  addPolygons(data = protected_areas_sanjose,
              group = "Protected Areas",
              stroke = TRUE, color = col_BoldGrassGreen, weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = TRUE, fillOpacity = 0.8,
              highlight = highlightOptions(
                weight = 5,
                color = col_LightGrassGreen,
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>% 
  # Layers control
  addLayersControl(
    baseGroups = c("Toner Lite","OSM","CartoDB"),
    overlayGroups = c("Municipality boundaries", "Protected Areas"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  hideGroup("Municipality boundaries")
```


```{r protected_area_barplot, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
protectedarea_percent_by_municipality = read.csv("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/protectedarea_percent_by_municipality.csv")

# rename columns
protectedarea_percent_by_municipality = protectedarea_percent_by_municipality %>% 
  rename_with(.cols = 1, ~'municpality_name') %>% 
  rename_with(.cols = 2, ~'percent_protected_area')

# plot chart
protectedarea_percent_by_municipality %>% 
  arrange(desc(percent_protected_area)) %>%
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(municpality_name), 
            y = ~percent_protected_area, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Percent of protected area by municipality (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~percent_protected_area),
         yaxis = list(title = 'Percent of protected area (%)'))
```