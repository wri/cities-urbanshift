---
title: "UrbanShift Biodiversity Indicators"
author: "Saif Shabou"
date: "`r format (Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    theme: spacelab
    highlight: tango
    number_sections: yes
    code_folding: hide
---

```{r Libraries, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}

# library(shiny)
library(plotly)
library(leaflet)
library(plyr)
library(dplyr)
library(ggplot2)
library(rgdal)
library(tidyverse)
library(sf)
library(rgeos)
library(httr)
library(jsonlite)
library(raster)
library(data.table)
library(leaflet.providers)
library(knitr)
library(kableExtra)
library(reactable)
library(readxl)
col_BoldRiverBlue = "#242456"
col_BoldSunYellow = "#FFD450"
col_BoldGrassGreen = "#2A553E"
col_BoldEarthGrey = "#7B7A66"
col_BoldBrickOrange = "#F26640"
col_LightRiverBlue = "#E3E6FF"
col_LightSunYellow = "#FFEDBA"
col_LightGrassGreen = "#C4F4D5"
col_LightEarthGrey = "#ECE2D6"
col_LightBrickOrange = "#FED3CF"
col_White = "#FFFFFF"
col_Black = "#000000"



```

# The UrbanShift project

## Objectives

UrbanShift is a global program that supports cities to adopt integrated approaches to urban development, shaping low-carbon, climate-resilient communities where people and planet both can thrive. The program is funded by the Global Environment Facility (GEF) and jointly managed by a global team consisting of the United Nations Environment Program (UNEP), World Resources Institute (WRI), C40 Cities and ICLEI Local Governments for Sustainability. The initiative supports 23 cities across nine countries, providing the knowledge, tools and training they need to transform their urban fabric and shift towards a more sustainable, equitable future.

As one of the key activities to support development of a knowledge-base for the UrbanShift initiative and all participant cities, the WRI data team will work with UrbanShift cities to identify and provide all cities with a common set of critical spatial data layers. using open source, global data. World Resources Institute is providing several types of data-related assistance to participating cities:

- A suite of key geo-spatial layers
- Baseline measurements of core UrbanShift indicators
- Geo-spatial analysis on selected thematic areas
- Capacity building and technical assistance on data governance and geospatial data as part of the City Academy and Labs modules of UrbanShift.

Outputs will include datasets, indicators and replicable analysis methods relevant to all cities. Additionally, analyses customized to the specific themes of interest for each city will be provided. Finally, an UrbanShift Lab will be delivered for which these data and analyses may act as one input.

## Baseline indicators

To help understand the current status and identify changes of sustainability in UrbanShift cities, we aim to measure **key baseline indicators** for all cities using comparable approaches. The selected indicators focus on measuring the status and change on the core objectives of the global project, which are aligned with three of Global Environment Facility's [focal areas for its current investment cycle (GEF-7)](https://www.thegef.org/documents/gef-7-programming-directions):**land degradation, biodiversity, and greenhouse gas emissions**. 

These assessments are intended to provide information to evaluate patterns within and between cities and to provide contextual information to cities to help them with problem and solution definition. We will disseminate the results to help local governments, the global project team, implementing agencies and national governments to gain a better understanding of the cities’ current status as it relates to sustainability efforts, capacities, main needs and opportunities, and planned investments.

# Biodiversity

## The Singapore Index on cities' Biodiversity 

The City Biodiversity Index was launched by Singapore in 2008 at the eight Conference of the Parties to the convention on Biological Diversity (DBD). It serves as a self-assessment tool for cities to monitor the progress of their biodiversity conservation efforts.

The Singapore Index framework is constituted of two parts:

- *The profile of the City*: It provides background information on the city: location, size, population, economic parameters, physical features, biodiversity features, administration....
- *Biodiversity indicators*: It includes 28 indicators that measure native biodiversity, ecosystem services and management of biodiversity in the city. Each indicator is assigned a scoring range between zero and four points. 


```{r sangapore-biodiversity-index, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}


singapore_biodiversity_index = data.frame(core_components = c(rep("Native Biodivesity in the City",9),
                                                              rep("Ecosystem Services provided by Biodiversity",5),
                                                              rep("Governance and Management of Biodiversity",14)),
                                          indicators = c("1. Proportion of Natural Areas in the City",
                                                         "2. Connectivity Measures or Ecological Networks to Counter Fragmentation",
                                                         "3. Native Biodiversity in Built Up Areas (Bird Species",
                                                         "4. Change in Number of Vascular Plant Species",
                                                         "5. Change in Number of Native Bird Species",
                                                         "6. Change in Number of Native Arthropod Species",
                                                         "7. Habitat Restoration",
                                                         "8. Proportion of Protected Natural Areas",
                                                         "9. Proportion of Invasive Alien Species",
                                                         "10. Regulation of Quantity of Water",
                                                         "11. Climate Regulation – Benefits of Trees and Greenery",
                                                         "12. Recreational Services",
                                                         "13. Health and Wellbeing – Proximity/Accessibility to Parks",
                                                         "14. Food Security Resilience – Urban Agriculture",
                                                         "15. Institutional Capacity",
                                                         "16. Budget Allocated to Biodiversity",
                                                         "17. Policies, Rules and Regulations – Existence of Local Biodiversity Strategy and Action Plan",
                                                         "18. Status of Natural Capital Assessment in the City",
                                                         "19. State of Green and Blue Space Management Plans in the City",
                                                         "20. Biodiversity Related Responses to Climate Change",
                                                         "21. Policy and/or Incentives for Green Infrastructure as Nature-based Solutions",
                                                         "22. Cross-sectoral and Inter-agency Collaborations",
                                                         "23. Participation and Partnership: Existence of Formal or Informal Public Consultation Process Pertaining to Biodiversity Related Matter",
                                                         "24. Participation and Partnership: Number of Agencies/Private Companies/NGOs/Academic Institutions/International Organisations with which the City is Partnering in Biodiversity Activities, Projects and Programmes",
                                                         "25. Number of Biodiversity Projects Implemented by the City Annually",
                                                         "26. Education",
                                                         "27. Awareness",
                                                         "28. Community Science")
)

reactable(
  singapore_biodiversity_index,
  columns = list(
    core_components = colDef(name = "Core components"),
    indicators = colDef(name = "Indicators")
  ),
  groupBy = "core_components",
  onClick = "expand",
  # Give rows a pointer cursor to indicate that they're clickable
  rowStyle = list(cursor = "pointer")
)
```

The complete methodology for computing Singapore Biodiversity Index is provide in [this publication](https://www.cbd.int/doc/publications/cbd-ts-98-en.pdf).


## UrbanShift Biodiversity indicators

| Indicator name | Definition | Data sources |
| ------- | ------- | ------- | 
| I-1. Proportion of natural areas | (Total area of natural, restored and naturalised areas) ÷ (Area of city) × 100% | `ESA WorldCover (natural areas as all values except crop, built-up, bare)` | 
| I-2. Connectivity measures or ecological networks to counter fragmentation |  |` ESA WorldCover (natural areas as all values except crop, built-up, bare)` | 
| I-3. Native biodiversity in built-up areas (birds) | (Number of native bird species found in built-up areas) ÷ (Total number of native bird species in the city) × 100% | `ESA WorldCover`, `iNaturalist 2020 research-grade observations` | 
| I-3. Native biodiversity in built-up areas (birds) | (Number of native bird species found in built-up areas) ÷ (Total number of native bird species in the city) × 100% | `ESA WorldCover`, `iNaturalist 2020 research-grade observations` | 
| I-4. Change in number of native species (vascular plants) | Total increase in number of vascular plant species (as a result of re-introduction, rediscovery, new species found due to more intensive and comprehensive surveys, etc.) | `iNaturalist 2020 research-grade observations` | 
|I-5. Change in number of native species (birds) | Total increase in number of native bird species (as a result of re-introduction, rediscovery, new species found due to more intensive and comprehensive surveys, etc.) | `iNaturalist 2020 research-grade observations` | 
|I-6. Change in number of native species (arthropods)| Total increase in number of native arthropod species (as a result of re-introduction, rediscovery, new species found due to more intensive and comprehensive surveys, etc.) | `iNaturalist 2020 research-grade observations` | 
|I-7. Habitat restoration| (Area of habitat restored*) ÷ (Area of original habitat that 
is degraded**) × 100% |  | 
|I-8. Proportion of protected natural areas | (Area of protected or secured natural areas) ÷ (Total area of the city) × 100% |   `World Database of Protected Areas`| 
|I-9. Proportion of invasive alien species | To ensure that the comparison of invasive alien specie with that of native species is meaningful, it would have to be a comparison of identical taxonomic groups.(Number of invasive alien species in a taxonomic group) ÷ (Total number of native species of the same taxonomic group + number of invasive alien species) × 100% | `Global Invasive Species Database`| 
|I-10. Regulation of quantity of water | (Total permeable area) ÷ (Total terrestrial area of the city) × 100% | `GAIA 2018 30m impervious area`| 
|I-11. Climate regulation: carbon storage and cooling effect of vegetation | (Tree canopy cover) ÷ (Total terrestrial area of the city) × 100% | | 
|I-12. Recreational services | (Area of parks, nature conservation areas and other green spaces with natural areas and protected or secured accessible natural areas) /1000 persons | `OpenStreetMap`, `WorldPop` | |
|I-13 Proximity to parks | (Population of city living within 400m from a park/green space) ÷ (Total population of city) × 100% | `OpenStreetMap`, `WorldPop` | 


## Data sources


- **Global Biodiversity Information Facility (GBIF)**: [The Global Biodiversity Information Facility (GBIF)](https://www.gbif.org/en/) is an international network and data infrastructure funded by the world's governments and aimed at providing anyone, anywhere, open access to data about all types of life on Earth. 

- **The World Database on Protected Areas (WDPA)**: [The World Database on Protected Areas (WDPA)](https://www.protectedplanet.net/en) is the most comprehensive global database of marine and terrestrial protected areas. It is a joint project between UN Environment Programme and the International Union for Conservation of Nature (IUCN), and is managed by UN Environment Programme World Conservation Monitoring Centre (UNEP-WCMC), in collaboration with governments, non-governmental organisations, academia and industry.

- **The Global Invasive Species Database (GISD)**: [The Global Invasive Species Database (GISD)](http://www.iucngisd.org/gisd/) is a free, online searchable source of information about alien and invasive species that negatively impact biodiversity. It focuses on invasive alien species that threaten native biodiversity and natural areas and covers all taxonomic groups from micro-organisms to animals and plants.

- **ESA World Cover**: [The European Space Agency (ESA) WorldCover 10 m 2020 product](https://esa-worldcover.org/en) provides a global land cover map for 2020 at 10 m resolution based on Sentinel-1 and Sentinel-2 data. The WorldCover product comes with 11 land cover classes, aligned with UN-FAO's Land Cover Classification System, and has been generated in the framework of the ESA WorldCover project.

# Case study: San Jose

## Data sources exploration

### ESA World Cover

The European Space Agency (ESA) WorldCover 10 m 2020 product provides a global land cover map for 2020 at 10 m resolution based on Sentinel-1 and Sentinel-2 data. The WorldCover project, part of the 5th Earth Observation Envelope Programme (EOEP-5), had the objective to produce, deliver and validate, as fast as possible, a global 10 meter resolution land cover (LC) map of the world within 3 months of the last data acquisition with a minimum of 10 land cover classes and a minimum overall accuracy of 75%. 

The WorldCover product comes with 11 land cover classes:

- *Tree cover*: This class includes any geographic area dominated by trees with a cover of 10% or more. Areas planted with trees for afforestation purposes and plantations (e.g. oil palm, olive trees) are included in this class. This class also includes tree covered areas seasonally or permanently flooded with fresh water except for mangroves.
- *Shrubland*: This class includes any geographic area dominated by natural shrubs having a cover of 10% or more. Shrubs are defined as woody perennial plants with persistent and woody stems and without any defined main stem being less than 5 m tall. 
- *Grassland*: This class includes any geographic area dominated by natural herbaceous plants (Plants without persistent stem or shoots above ground and lacking definite firm structure): (grasslands, prairies, steppes, savannahs, pastures) with a cover of 10% or more, irrespective of different human and/or animal activities.
- *Cropland*: Land covered with annual cropland that is sowed/planted and harvestable at least once within the 12 months after the sowing/planting date.
- *Built-up*: Land covered by buildings, roads and other man-made structures such as railroads. Buildings include both residential and industrial building.
- *Bare / sparse vegetation*: Lands with exposed soil, sand, or rocks and never has more than 10% vegetated cover during any time of the year.
- *Snow and ice*: This class includes any geographic area covered by snow or glaciers persistently.
- *Open water*: This class includes any geographic area covered for most of the year (more than 9 months) by water bodies: lakes, reservoirs, and rivers. 
- *Herbaceous wetland*: Land dominated by natural herbaceous vegetation (cover of 10% or more) that is permanently or regularly flooded by fresh, brackish or salt water. 
- *Mangroves*: Taxonomically diverse, salt-tolerant tree and other plant species which thrive in intertidal zones of sheltered tropical shores, "overwash" islands, and estuaries.
- *Moss and lichen*: Land covered with lichens and/or mosses. Lichens are composite organisms formed from the symbiotic association of fungi and algae. Mosses contain photo-autotrophic land plants without true leaves, stems, roots but with leaf-and stemlike organs.

```{r boundary, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# read Boundary
boundary = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/data/boundaries/CRI-San_Jose-boundary.geojson", quiet = TRUE)

boundary_municipality = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/boundaries-CRI-San_Jose-ADM2.geojson",
                                quiet = TRUE)

```

```{r worldcover_map, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}

# read worldcover raster
worldcoverc_data_path = "https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/indicators_biodiversity_CRI-San_Jose-esa-worldcover-2020.tif"

city_worldcover_raster= raster(worldcoverc_data_path)

# read admin boundary of sanjose city
boundary_municipality_SanJose = boundary_municipality[boundary_municipality$shapeName.1 == "Cantón San José", ]

# crop raster for sanjose city
municipality_SanJose_worldcover  = raster::crop(city_worldcover_raster,boundary_municipality_SanJose)
municipality_SanJose_worldcover  = raster::mask(municipality_SanJose_worldcover,boundary_municipality_SanJose)

# define colors for each class

Trees_10_green = "#006400"
Shrubland_20_orange = "#ffbb22"
Grassland_30_yellow = "#ffff4c" 
Cropland_40_mauve = "#f096ff"
Built_up_50_red = "#fa0000"
Barren_sparse_vegetation_60_gray = "#b4b4b4"
Snow_ice_70_white = "#f0f0f0"
Open_Water_80_blue = "#0064c8"
Herbaceous_wetland_90_blue2 = "#0096a0"
Mangroves_95_green2 = "#00cf75"
Moss_lichen_100_beige = "#fae6a0"

# define color vector
worldcover_col = c(Trees_10_green,
                   Shrubland_20_orange,
                   Grassland_30_yellow,
                   Cropland_40_mauve,
                   Built_up_50_red,
                   Barren_sparse_vegetation_60_gray,
                   Open_Water_80_blue)

# define a color palette
pal_worldcover <- colorFactor(worldcover_col, 
                              values(municipality_SanJose_worldcover),
                              na.color = "transparent")
# define labels
labels_worldcover = c('Trees','Shrubland','Grassland','Cropland','	Built-up',
                      'Barren / sparse vegetation','Open water')

# create the map
map = leaflet(municipality_SanJose_worldcover, height = 500, width = "100%")  %>%
  addTiles() %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
  addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
  addPolygons(data = boundary_municipality_SanJose,
              group = "Administrative boundaries",
              stroke = TRUE, color = "gray", weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = FALSE, fillOpacity = 0.5,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = TRUE),
              label = boundary_municipality_SanJose$name,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>%
  addRasterImage(municipality_SanJose_worldcover, 
                 colors = pal_worldcover, 
                 opacity = 0.9,
                 maxBytes = 20 * 1024 * 1024,
                 group = "World Cover") %>%
  # addLegend(pal = pal_worldcover,
  #           values = values(municipality_SanJose_worldcover),
  #           title = "World Cover") %>% 
  addLegend(colors = worldcover_col,
            labels = labels_worldcover,
            title = "World Cover") %>%
  addLayersControl(
    baseGroups = c("Toner Lite", "OSM","CartoDB"),
    overlayGroups = c("World Cover","Administrative boundaries"),
    options = layersControlOptions(collapsed = FALSE)
  )

map

```

```{r worldcover_stat, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
year = 2020

city_worldcover_stat = as.data.frame(city_worldcover_raster) %>%
  rename_at(1, ~"class" ) %>% 
  drop_na(class) %>% 
  group_by(class) %>%
  tally() %>%
  mutate(area = n * res(city_worldcover_raster)[1] * res(city_worldcover_raster)[2]) %>% 
  dplyr::select(land_cover_classes = class,
                nb_cells = n) %>% 
  mutate(land_cover_percent = round(nb_cells/sum(nb_cells) * 100,2))%>% 
  add_column(year = year) %>% 
  arrange(desc(land_cover_percent)) %>%
  mutate_at("land_cover_classes", as.character) %>%
  mutate(land_cover_classes = recode(land_cover_classes,
                                   "10" =  "Trees",
                                   "20" = "Shrubland" ,
                                   "30" = "Grassland",
                                   "40" = "Cropland",
                                   "50" =  "Built-up",
                                   "60" = "Barren / sparse vegetation",
                                   "70" = "Snow and ice",
                                   "80" = "Open water",
                                   "90" = "Herbaceous wetland",
                                   "95" = "Mangroves",
                                   "100" = "Moss and lichen")) %>% 
  dplyr::select('land cover class' = land_cover_classes,
                'land percent' = land_cover_percent,
                'year' = year)


# plot table
city_worldcover_stat %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, font_size = 13)%>% 
  scroll_box(width = "100%", height = "300px")

```

### Global Biodiversity Information Facility (GBIF)

#### Metropolitan level

- **Location of reported birds:**

```{r Birds_map, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}


birds2020 = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/data/biodiversity/biodiversity_map_layers_birds2020_sanjose.geojson",
                    quiet = TRUE)


label_birds2020 <- sprintf(
  "<strong>%s</strong><br/><strong>%s</strong><br/>",
  paste("Family", birds2020$family, sep=": "), 
  paste("Genus", birds2020$genus, sep =": ")
) %>% 
  lapply(htmltools::HTML)

leaflet(data = boundary, height = 500, width = "100%") %>% 
  addTiles() %>%
  addProviderTiles("OpenStreetMap.France", group = "OSM") %>%
  addProviderTiles(providers$CartoDB.DarkMatter , group = "CartoDB") %>% 
  # addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # setView(lat = boundary_centroid_lat,
  #         lng = boundary_centroid_lon,
  #         zoom = 9) %>% 
  # Add boundaries
  addPolygons(data = boundary,
              group = "Administrative boundaries",
              stroke = TRUE, color = col_Black, weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = TRUE, fillOpacity = 0.2,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>%
  addMarkers(birds2020$lon, 
             birds2020$lat,
             popup = ~as.character(birds2020$family),
             label = label_birds2020,
             clusterOptions = markerClusterOptions(),
             group = "Birds clusters") %>% 
  # add birds layer
  addCircleMarkers(birds2020$lon, birds2020$lat, 
                   radius = 3,
                   fillColor = col_BoldBrickOrange,
                   color  = "black",
                   stroke = TRUE,
                   weight = 0.8,
                   fillOpacity = 0.6,
                   popup = ~as.character(birds2020$family),
                   label = label_birds2020,
                   group = "Birds observations") %>% 
  # Layers control
  addLayersControl(
    baseGroups = c("OSM","CartoDB"),
    overlayGroups = c("Birds clusters","Birds observations"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
    hideGroup("Birds observations")
```

- **Number of reported birds by order:**

```{r Birds_stat_sanjose_orders, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# orders ----
birds2020_stats_orders = birds2020 %>% 
  as.data.frame() %>% 
  group_by(order) %>%
  summarise(nb_species = n()) %>% 
  arrange(desc(nb_species)) %>% 
  dplyr::select(`order name` = order,
         `Number of species`= nb_species)

# plot chart
birds2020_stats_orders %>% 
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(`order name`), 
            y = ~`Number of species`, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Number of birds by order (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~`Number of species`),
         yaxis = list(title = 'Number of observations in 2020'))
```

- **Number of reported birds by family:**

```{r Birds_stat_sanjose_family, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# families ----

birds2020_stats_families = birds2020 %>% 
  as.data.frame() %>% 
  group_by(family) %>%
  summarise(nb_species = n()) %>% 
  arrange(desc(nb_species)) %>% 
  dplyr::select(`family name` = family,
                `Number of species`= nb_species)

# plot chart
birds2020_stats_families %>% 
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(`family name`), 
            y = ~`Number of species`, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Number of birds by family (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~`Number of species`),
         yaxis = list(title = 'Number of observations in 2020'))
         
```

- **Number of reported birds by genus:**

```{r Birds_stat_sanjose_genus, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# genus ----

birds2020_stats_genus = birds2020 %>% 
  as.data.frame() %>% 
  group_by(genus) %>%
  summarise(nb_species = n()) %>% 
  arrange(desc(nb_species)) %>% 
  dplyr::select(`genus name` = genus,
                `Number of species`= nb_species)

# plot table
birds2020_stats_genus %>% 
  arrange(desc(`Number of species`)) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, font_size = 13)%>% 
  scroll_box(width = "100%", height = "400px")
         
```

#### Municipality level

```{r Birds_map_adm2, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
boundary_municipality = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/boundaries-CRI-San_Jose-ADM2.geojson",
                                quiet = TRUE)

# find birds observations within municipalities polygons
birds_in_geo_adm2 <- st_join(x = birds2020, 
                             y = boundary_municipality, 
                             join = st_within)

# agregate number of birds observations by municipality 
birds_in_geo_adm2_stat = birds_in_geo_adm2 %>% 
  as.data.frame() %>% 
  count(shapeName.1) %>% 
  dplyr::select(shapeName.1,
         nb_species = n)  
  
# join with geo
birds_adm2_stat_geo = boundary_municipality %>% 
  left_join(birds_in_geo_adm2_stat,
            by = c("shapeName.1"))

# prepare map

# define color palette for urban expansion levels
pal_nbspecieis_municipality <- colorNumeric(palette = "Reds", 
                                             domain = birds_adm2_stat_geo$nb_species,
                                             na.color = "transparent",
                                             revers = FALSE)

# define map labels
labels_adm2_nbspecies <- sprintf("<strong>%s</strong><br/>%s: %s %s",
                  birds_adm2_stat_geo$shapeName.1, 
                  "Observations: ",
                  round(birds_adm2_stat_geo$nb_species, 2), "") %>% 
  lapply(htmltools::HTML)


# plot map
leaflet(height = 500, width = "100%") %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.DarkMatter , group = "CartoDB") %>%
  addProviderTiles("OpenStreetMap.France", group = "OSM") %>%
  addPolygons(data = birds_adm2_stat_geo,
              group = "Nb species",
              fillColor = ~pal_nbspecieis_municipality(nb_species),
              weight = 1,
              opacity = 1,
              color = "grey",
              fillOpacity = 0.7,
              label = labels_adm2_nbspecies,
              highlightOptions = highlightOptions(color = "black", weight = 2,
                                                  bringToFront = FALSE),
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 6px"),
                textsize = "15px",
                direction = "auto")) %>% 
  addLegend(pal = pal_nbspecieis_municipality, 
            values = birds_adm2_stat_geo$nb_species, 
            opacity = 0.9, 
            title = "Number of species (2020)",
            position = "topright",
            labFormat = labelFormat(suffix = "")) %>%
  # add birds layer
  addCircleMarkers(birds2020$lon, birds2020$lat,
                   radius = 3,
                   fillColor = col_BoldRiverBlue,
                   color  = "black",
                   stroke = TRUE,
                   weight = 0.8,
                   fillOpacity = 0.6,
                   label = label_birds2020,
                   group = "Birds observations") %>% 
  # Layers control
  addLayersControl(
    baseGroups = c("CartoDB","OSM"),
    overlayGroups = c("Nb species", "Birds observations"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  hideGroup("Birds observations")
```

```{r Birds_barplot_adm2, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# plot chart
birds_in_geo_adm2_stat %>% 
  arrange(desc(nb_species)) %>%
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(shapeName.1), 
            y = ~nb_species, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Number of birds by municipality (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~nb_species),
         yaxis = list(title = 'Number of observations in 2020'))
```


### World Database on Protected Areas (WDPA)

```{r protected_area_map, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
# protected areas map -----
protected_areas_sanjose = st_read("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/biodiversity_map_layers_protected_areas_sanjose.geojson",
                                    quiet = TRUE)

leaflet(data = boundary, height = 500, width = "100%") %>% 
  addTiles() %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addProviderTiles("OpenStreetMap.France", group = "OSM") %>%
  addProviderTiles(providers$CartoDB.DarkMatter , group = "CartoDB") %>% 
  # Add boundaries: metropolitan
  addPolygons(data = boundary,
              group = "Administrative boundaries",
              stroke = TRUE, color = col_Black, weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = FALSE, fillOpacity = 0.2,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>%
  # Add boundaries: Municipality
  addPolygons(data = boundary_municipality,
              group = "Municipality boundaries",
              stroke = TRUE, color = "gray", weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = TRUE, fillOpacity = 0.2,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>%
  # add protected areas layer
  addPolygons(data = protected_areas_sanjose,
              group = "Protected Areas",
              stroke = TRUE, color = col_BoldGrassGreen, weight = 3,dashArray = "3",
              smoothFactor = 0.3, fill = TRUE, fillOpacity = 0.8,
              highlight = highlightOptions(
                weight = 5,
                color = col_LightGrassGreen,
                dashArray = "",
                fillOpacity = 0.3,
                bringToFront = FALSE)) %>% 
  # Layers control
  addLayersControl(
    baseGroups = c("Toner Lite","OSM","CartoDB"),
    overlayGroups = c("Municipality boundaries", "Protected Areas"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  hideGroup("Municipality boundaries")
```


```{r protected_area_barplot, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
protectedarea_percent_by_municipality = read.csv("https://cities-urbanshift.s3.eu-west-3.amazonaws.com/baseline-indicators/biodiversity/data/protectedarea_percent_by_municipality.csv")

# rename columns
protectedarea_percent_by_municipality = protectedarea_percent_by_municipality %>% 
  rename_with(.cols = 1, ~'municpality_name') %>% 
  rename_with(.cols = 2, ~'percent_protected_area')

# plot chart
protectedarea_percent_by_municipality %>% 
  arrange(desc(percent_protected_area)) %>%
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(municpality_name), 
            y = ~percent_protected_area, 
            marker = list(color = col_BoldRiverBlue),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Percent of protected area by municipality (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~percent_protected_area),
         yaxis = list(title = 'Percent of protected area (%)'))
```

## Baseline indicators

### I-1. Porportion of natural areas

```{r percent_natural_areas, warning=FALSE, message=FALSE, echo = FALSE,  eval = TRUE}
biodiversity_baseline_indicators <- read_excel("./data/biodiversity/biodiversity baseline indicators.xlsx", sheet = "SCORES")

# I-1. Porportion of natural areas

boundary_municipality$Municipality = str_remove(boundary_municipality$shapeName.1, "Cantón ")
# change encoding
boundary_municipality$Municipality = iconv(boundary_municipality$Municipality,from="UTF-8",to="ASCII//TRANSLIT")

# join with geo
biodiversity_baseline_indicators_geo = boundary_municipality %>% 
  left_join(biodiversity_baseline_indicators,
            by = c("Municipality")) %>% 
  rename(percent_natural_areas = 'I-1 raw')

# prepare map

# define color palette for urban expansion levels
pal_I1 <- colorNumeric(palette = "Greens", 
                       domain = biodiversity_baseline_indicators_geo$percent_natural_areas,
                       na.color = "transparent",
                       revers = FALSE)

# define map labels
labels_I1 <- sprintf("<strong>%s</strong><br/>%s: %s %s",
                     biodiversity_baseline_indicators_geo$shapeName.1,
                     "Proportion of natural areas: ",
                     round(biodiversity_baseline_indicators_geo$percent_natural_areas, 2), "") %>% 
  lapply(htmltools::HTML)


# plot map
leaflet(height = 500, width = "100%") %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.DarkMatter , group = "CartoDB") %>%
  addProviderTiles("OpenStreetMap.France", group = "OSM") %>%
  addPolygons(data = biodiversity_baseline_indicators_geo,
              group = "Porportion of natural areas",
              fillColor = ~pal_I1(percent_natural_areas),
              weight = 1,
              opacity = 1,
              color = "grey",
              fillOpacity = 0.7,
              label = labels_I1,
              highlightOptions = highlightOptions(color = "black", weight = 2,
                                                  bringToFront = FALSE),
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 6px"),
                textsize = "15px",
                direction = "auto")) %>% 
  addLegend(pal = pal_I1,
            values = biodiversity_baseline_indicators_geo$percent_natural_areas,
            opacity = 0.9,
            title = "% natural areas (2020)",
            position = "topright",
            labFormat = labelFormat(suffix = "")) %>%
  # Layers control
  addLayersControl(
    baseGroups = c("CartoDB","OSM"),
    overlayGroups = c("Porportion of natural areas"),
    options = layersControlOptions(collapsed = FALSE)
  ) 

# plot chart
biodiversity_baseline_indicators_geo %>% 
  arrange(desc(percent_natural_areas)) %>%
  plot_ly(height = 500, width = 900) %>% 
  add_trace(x = ~factor(Municipality), 
            y = ~percent_natural_areas, 
            marker = list(color = col_BoldGrassGreen),
            type = "bar",
            orientation = "v")  %>% 
  layout(title = "Percent of natural areas (2020)",
         xaxis = list(title = '', categoryorder = "array",categoryarray = ~percent_natural_areas),
         yaxis = list(title = 'Percent of natiral area (%)'))
```

### I-2. Connectivity measures or ecological networks to counter fragmentation

### I-3 Connectivity measures or ecological networks to counter fragmentation

